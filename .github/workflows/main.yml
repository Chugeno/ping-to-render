name: Monitor n8n con Log de Errores

on:
  schedule:
    - cron: "*/12 * * * *"
  workflow_dispatch:

jobs:
  check-and-log:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      # 1. Obtenemos la fecha
      - name: Get current date
        id: date
        run: echo "timestamp=$(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> $GITHUB_OUTPUT

      # 2. Ping LIMPIO (Solo captura el error real)
      - name: Ping n8n Webhook
        id: ping_n8n
        continue-on-error: true 
        run: |
          # --silent: No muestra barra de progreso ni basura
          # --show-error: Si falla, muestra el error (ej: 404 Not Found)
          # 2> output.txt: Guardamos solo el error en el archivo
          
          if curl --request GET \
            --url "https://n8n-dnlu.onrender.com/webhook/49fea9ce-864f-4d42-968c-7c19fea1029d" \
            --max-time 120 \
            --retry 3 \
            --fail \
            --silent \
            --show-error 2> output.txt; then
            
            echo "outcome=success" >> $GITHUB_OUTPUT
            echo "‚úÖ Ping exitoso"
          else
            echo "outcome=failure" >> $GITHUB_OUTPUT
            
            # Leemos el archivo de error
            ERROR_MSG=$(cat output.txt)
            
            # Si por alguna raz√≥n est√° vac√≠o, ponemos un texto por defecto
            if [ -z "$ERROR_MSG" ]; then
              ERROR_MSG="Error desconocido (Timeout o Conexi√≥n)"
            fi

            # Limpiamos comillas dobles para no romper el JSON de Notion
            ERROR_CLEAN=$(echo "$ERROR_MSG" | tr -d '"' | tr '\n' ' ')
            
            echo "error_msg=$ERROR_CLEAN" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è ERROR CAPTURADO: $ERROR_CLEAN"
            exit 1
          fi

      # 3. Log OK (Si ping fue exitoso)
      - name: Log OK to Notion
        if: steps.ping_n8n.outputs.outcome == 'success'
        run: |
          curl -X POST 'https://api.notion.com/v1/pages' \
            -H 'Authorization: Bearer ${{ secrets.NOTION_TOKEN }}' \
            -H 'Content-Type: application/json' \
            -H 'Notion-Version: 2022-06-28' \
            --data '{
              "parent": { "database_id": "${{ secrets.NOTION_DATABASE_ID }}" },
              "properties": {
                "Nombre": { "title": [ { "text": { "content": "Ping GitHub Action" } } ] },
                "Estado": { "select": { "name": "üü¢ OK" } },
                "Fecha": { "date": { "start": "${{ steps.date.outputs.timestamp }}" } },
                "Detalle": { "rich_text": [ { "text": { "content": "Respuesta 200 OK" } } ] }
              }
            }'

      # 4. Log ERROR (Con el mensaje capturado)
      - name: Log ERROR to Notion
        if: steps.ping_n8n.outputs.outcome == 'failure'
        run: |
          curl -X POST 'https://api.notion.com/v1/pages' \
            -H 'Authorization: Bearer ${{ secrets.NOTION_TOKEN }}' \
            -H 'Content-Type: application/json' \
            -H 'Notion-Version: 2022-06-28' \
            --data '{
              "parent": { "database_id": "${{ secrets.NOTION_DATABASE_ID }}" },
              "properties": {
                "Nombre": { "title": [ { "text": { "content": "FALLO DE CONEXI√ìN" } } ] },
                "Estado": { "select": { "name": "üî¥ ERROR" } },
                "Fecha": { "date": { "start": "${{ steps.date.outputs.timestamp }}" } },
                "Detalle": { "rich_text": [ { "text": { "content": "${{ steps.ping_n8n.outputs.error_msg }}" } } ] }
              }
            }'
