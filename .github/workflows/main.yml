name: Monitor n8n con Log Directo a Notion

on:
  schedule:
    - cron: "*/14 * * * *"
  workflow_dispatch:

jobs:
  check-and-log:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      # 1. Obtenemos la fecha en formato ISO 8601 (El favorito de Notion)
      - name: Get current date
        id: date
        run: echo "timestamp=$(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> $GITHUB_OUTPUT

      # 2. Intentamos despertar a n8n
      - name: Ping n8n Webhook
        id: ping_n8n
        continue-on-error: true 
        run: |
          curl --request GET \
          --url "https://n8n-dnlu.onrender.com/webhook/monitor-ping" \
          --max-time 120 \
          --retry 3 \
          --fail

      # 3. Log OK (Si ping fue exitoso)
      - name: Log OK to Notion
        if: steps.ping_n8n.outcome == 'success'
        run: |
          curl -X POST 'https://api.notion.com/v1/pages' \
            -H 'Authorization: Bearer ${{ secrets.NOTION_TOKEN }}' \
            -H 'Content-Type: application/json' \
            -H 'Notion-Version: 2022-06-28' \
            --data '{
              "parent": { "database_id": "${{ secrets.NOTION_DATABASE_ID }}" },
              "properties": {
                "Nombre": { 
                  "title": [ { "text": { "content": "Ping GitHub Action" } } ] 
                },
                "Estado": { 
                  "select": { "name": "ðŸŸ¢ OK" } 
                },
                "Fecha": { 
                  "date": { "start": "${{ steps.date.outputs.timestamp }}" } 
                }
              }
            }'

      # 4. Log ERROR (Si ping fallÃ³)
      - name: Log ERROR to Notion
        if: steps.ping_n8n.outcome == 'failure'
        run: |
          curl -X POST 'https://api.notion.com/v1/pages' \
            -H 'Authorization: Bearer ${{ secrets.NOTION_TOKEN }}' \
            -H 'Content-Type: application/json' \
            -H 'Notion-Version: 2022-06-28' \
            --data '{
              "parent": { "database_id": "${{ secrets.NOTION_DATABASE_ID }}" },
              "properties": {
                "Nombre": { 
                  "title": [ { "text": { "content": "FALLO DE CONEXIÃ“N" } } ] 
                },
                "Estado": { 
                  "select": { "name": "ðŸ”´ ERROR" } 
                },
                "Fecha": { 
                  "date": { "start": "${{ steps.date.outputs.timestamp }}" } 
                }
              }
            }'
