name: Monitor n8n con Log Directo a Notion

on:
  schedule:
    - cron: "*/14 * * * *"  # Cada 14 minutos
  workflow_dispatch:

jobs:
  check-and-log:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      # 1. Obtenemos la fecha actual para el log
      - name: Get current date
        id: date
        run: echo "timestamp=$(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT

      # 2. Intentamos despertar a n8n (Tu Webhook o el Healthz)
      - name: Ping n8n Webhook
        id: ping_n8n
        # Ponemos 'continue-on-error' para que si falla, podamos ejecutar el paso de reporte de error
        continue-on-error: true 
        run: |
          curl --request GET \
          --url "https://n8n-dnlu.onrender.com/webhook/49fea9ce-864f-4d42-968c-7c19fea1029d" \
          --max-time 120 \
          --retry 3 \
          --fail

      # 3. Si el Ping fue EXITOSO (Success) -> Escribimos OK en Notion
      - name: Log OK to Notion
        if: steps.ping_n8n.outcome == 'success'
        run: |
          curl -X POST 'https://api.notion.com/v1/pages' \
            -H 'Authorization: Bearer ${{ secrets.NOTION_TOKEN }}' \
            -H 'Content-Type: application/json' \
            -H 'Notion-Version: 2022-06-28' \
            --data '{
              "parent": { "database_id": "${{ secrets.NOTION_DATABASE_ID }}" },
              "properties": {
                "Name": { 
                  "title": [ { "text": { "content": "Ping GitHub Action" } } ] 
                },
                "Estado": { 
                  "select": { "name": "ðŸŸ¢ OK" } 
                },
                "Fecha": { 
                  "rich_text": [ { "text": { "content": "${{ steps.date.outputs.timestamp }}" } } ]
                }
              }
            }'

      # 4. Si el Ping FALLÃ“ (Failure) -> Escribimos ERROR en Notion
      - name: Log ERROR to Notion
        if: steps.ping_n8n.outcome == 'failure'
        run: |
          curl -X POST 'https://api.notion.com/v1/pages' \
            -H 'Authorization: Bearer ${{ secrets.NOTION_TOKEN }}' \
            -H 'Content-Type: application/json' \
            -H 'Notion-Version: 2022-06-28' \
            --data '{
              "parent": { "database_id": "${{ secrets.NOTION_DATABASE_ID }}" },
              "properties": {
                "Name": { 
                  "title": [ { "text": { "content": "FALLO DE CONEXIÃ“N" } } ] 
                },
                "Estado": { 
                  "select": { "name": "ðŸ”´ ERROR" } 
                },
                "Fecha": { 
                  "rich_text": [ { "text": { "content": "${{ steps.date.outputs.timestamp }}" } } ]
                }
              }
            }'
