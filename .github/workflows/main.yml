name: Monitor n8n con Log de Errores

on:
  schedule:
    - cron: "*/12 * * * *"  # Ajustado a 12 min para compensar retrasos de GitHub
  workflow_dispatch:

jobs:
  check-and-log:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      # 1. Obtenemos la fecha
      - name: Get current date
        id: date
        run: echo "timestamp=$(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> $GITHUB_OUTPUT

      # 2. Ping INTELIGENTE (Captura el error)
      - name: Ping n8n Webhook
        id: ping_n8n
        continue-on-error: true 
        run: |
          # Intentamos el curl y guardamos TODO (√©xito o error) en un archivo temporal output.txt
          # 2>&1 significa: "Manda los errores al mismo lugar que la salida normal"
          if curl -v --request GET \
            --url "https://dnlu.onrender.com/webhook/49fea9ce-864f-4d42-968c-7c19fea1029d" \
            --max-time 120 \
            --retry 3 \
            --fail 2>&1 > output.txt; then
            
            echo "outcome=success" >> $GITHUB_OUTPUT
          else
            echo "outcome=failure" >> $GITHUB_OUTPUT
            
            # LEER EL ERROR:
            # Tomamos las √∫ltimas lineas del log, quitamos comillas dobles y saltos de linea
            # para que no rompa el formato JSON de Notion.
            ERROR_CLEAN=$(cat output.txt | tail -n 5 | tr -d '"' | tr '\n' ' ')
            echo "error_msg=$ERROR_CLEAN" >> $GITHUB_OUTPUT
            
            # Imprimir en consola de GitHub para que lo veas aqu√≠ tambi√©n
            echo "‚ö†Ô∏è ERROR CAPTURADO: $ERROR_CLEAN"
            exit 1
          fi

      # 3. Log OK (Si ping fue exitoso) - Sin cambios aqu√≠
      - name: Log OK to Notion
        if: steps.ping_n8n.outputs.outcome == 'success'
        run: |
          curl -X POST 'https://api.notion.com/v1/pages' \
            -H 'Authorization: Bearer ${{ secrets.NOTION_TOKEN }}' \
            -H 'Content-Type: application/json' \
            -H 'Notion-Version: 2022-06-28' \
            --data '{
              "parent": { "database_id": "${{ secrets.NOTION_DATABASE_ID }}" },
              "properties": {
                "Nombre": { "title": [ { "text": { "content": "Ping GitHub Action" } } ] },
                "Estado": { "select": { "name": "üü¢ OK" } },
                "Fecha": { "date": { "start": "${{ steps.date.outputs.timestamp }}" } },
                "Detalle": { "rich_text": [ { "text": { "content": "Respuesta 200 OK" } } ] }
              }
            }'

      # 4. Log ERROR (Con el mensaje capturado)
      - name: Log ERROR to Notion
        if: steps.ping_n8n.outputs.outcome == 'failure'
        run: |
          curl -X POST 'https://api.notion.com/v1/pages' \
            -H 'Authorization: Bearer ${{ secrets.NOTION_TOKEN }}' \
            -H 'Content-Type: application/json' \
            -H 'Notion-Version: 2022-06-28' \
            --data '{
              "parent": { "database_id": "${{ secrets.NOTION_DATABASE_ID }}" },
              "properties": {
                "Nombre": { "title": [ { "text": { "content": "FALLO DE CONEXI√ìN" } } ] },
                "Estado": { "select": { "name": "üî¥ ERROR" } },
                "Fecha": { "date": { "start": "${{ steps.date.outputs.timestamp }}" } },
                "Detalle": { "rich_text": [ { "text": { "content": "${{ steps.ping_n8n.outputs.error_msg }}" } } ] }
              }
            }'
